par(mfcol = c(3,2))
boots <- bootstrap_data(data, short=T, level=1, name = "total_low_linear")
plot_regs(data, boots, "Total Deaths + Max low in Month", level = 1)
boots <- bootstrap_data(data, short=T, level=2, name = "total_low_quad")
plot_regs(data, boots, "Total Deaths + Max low in Month", level = 2)
boots <- bootstrap_data(data, short=T, level=3, name = "total_low_cub")
plot_regs(data, boots, "Total Deaths +  Max low in Month", level = 3)
data$deaths <- log(data$deaths)
boots <- bootstrap_data(data, short=T, level=1, name = "total_low_linear")
plot_regs(data, boots, "Total Deaths + Max low in Month", level = 1, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=2, name = "total_low_quad")
plot_regs(data, boots, "Total Deaths + Max low in Month", level = 2, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=3, name = "total_low_cub")
plot_regs(data, boots, "Total Deaths +  Max low in Month", level = 3, ylabel = "Log Mortality")
## Total Deaths, summer months, avg low temp in county, max low temp in month
t_low <- t %>% group_by(county, fips, month, year, monthyear) %>%
dplyr::filter(between(month, 5, 9)) %>%
summarize(maximum_low_temp_in_month = max(mean_low, na.rm = T),
avg_low_temp_in_month = mean(mean_low, na.rm = T))
data <- left_join(m, t_low, by = c("fips", "month", "year"))
data <- data %>%
group_by(fips, measure = maximum_low_temp_in_month - 273.15, monthyear, county = county.x, income_group, population_est) %>%
summarise(deaths = sum(deaths, na.rm = T)) %>%
dplyr::filter(is.finite(measure))
data <- na.omit(data)
par(mfcol = c(3,2))
boots <- bootstrap_data(data, short=T, level=1, name = "total_summer_low_linear")
plot_regs(data, boots, "Total Deaths Summer + Max low in Month", level = 1)
boots <- bootstrap_data(data, short=T, level=2, name = "total_summer_low_quad")
plot_regs(data, boots, "Total Deaths Summer + Max low in Month", level = 2)
boots <- bootstrap_data(data, short=T, level=3, name = "total_summer_low_cub")
plot_regs(data, boots, "Total Deaths Summer + Max low in Month", level = 3)
data$deaths <- log(data$deaths)
boots <- bootstrap_data(data, short=T, level=1, name = "total_summer_low_linear")
plot_regs(data, boots, "Total Deaths Summer + Max low in Month", level = 1, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=2, name = "total_summer_low_quad")
plot_regs(data, boots, "Total Deaths Summer + Max low in Month", level = 2, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=3, name = "total_summer_low_cub")
plot_regs(data, boots, "Total Deaths Summer + Max low in Month", level = 3, ylabel = "Log Mortality")
## PerCapita Deaths, all months, avg low temp in county, max low temp in month
t_low <- t %>% group_by(county, fips, month, year, monthyear) %>%
summarize(maximum_low_temp_in_month = max(mean_low, na.rm = T),
avg_low_temp_in_month = mean(mean_low, na.rm = T))
data <- left_join(m, t_low, by = c("fips", "month", "year"))
data <- data %>%
group_by(fips, measure = maximum_low_temp_in_month - 273.15, monthyear, county = county.x, income_group, population_est) %>%
summarise(deaths = sum(deaths, na.rm = T)) %>%
dplyr::filter(is.finite(measure)) %>%
mutate(deaths = (deaths/as.numeric(population_est))*10000)
data <- na.omit(data)
par(mfcol = c(3,2))
boots <- bootstrap_data(data, short=T, level=1, name = "total_low_linear")
plot_regs(data, boots, "Deaths per 10K + Max low in Month", level = 1)
boots <- bootstrap_data(data, short=T, level=2, name = "total_low_quad")
plot_regs(data, boots, "Deaths per 10K + Max low in Month", level = 2)
boots <- bootstrap_data(data, short=T, level=3, name = "total_low_cub")
plot_regs(data, boots, "Deaths per 10K + Max low in Month", level = 3)
data$deaths <- log(data$deaths)
boots <- bootstrap_data(data, short=T, level=1, name = "total_low_linear")
plot_regs(data, boots, "Deaths per 10K + Max low in Month", level = 1, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=2, name = "total_low_quad")
plot_regs(data, boots, "Deaths per 10K + Max low in Month", level = 2, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=3, name = "total_low_cub")
plot_regs(data, boots, "Deaths per 10K + Max low in Month", level = 3, ylabel = "Log Mortality")
## PerCapita Deaths, summer months, avg low temp in county, max low temp in month
t_low <- t %>% group_by(county, fips, month, year, monthyear) %>%
dplyr::filter(between(month, 5, 9)) %>%
summarize(maximum_low_temp_in_month = max(mean_low, na.rm = T),
avg_low_temp_in_month = mean(mean_low, na.rm = T))
data <- left_join(m, t_low, by = c("fips", "month", "year"))
data <- data %>%
group_by(fips, measure = maximum_low_temp_in_month - 273.15, monthyear, county = county.x, income_group, population_est) %>%
summarise(deaths = sum(deaths, na.rm = T)) %>%
dplyr::filter(is.finite(measure)) %>%
mutate(deaths = (deaths/as.numeric(population_est))*10000)
data <- na.omit(data)
par(mfcol = c(3,2))
boots <- bootstrap_data(data, short=T, level=1, name = "total_summer_low_linear")
plot_regs(data, boots, "Deaths per 10K Summer + Max low in Month", level = 1)
boots <- bootstrap_data(data, short=T, level=2, name = "total_summer_low_quad")
plot_regs(data, boots, "Deaths per 10K Summer + Max low in Month", level = 2)
boots <- bootstrap_data(data, short=T, level=3, name = "total_summer_low_cub")
plot_regs(data, boots, "Deaths per 10K Summer + Max low in Month", level = 3)
data$deaths <- log(data$deaths)
boots <- bootstrap_data(data, short=T, level=1, name = "total_summer_low_linear")
plot_regs(data, boots, "Deaths per 10K Summer + Max low in Month", level = 1, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=2, name = "total_summer_low_quad")
plot_regs(data, boots, "Deaths per 10K Summer + Max low in Month", level = 2, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=3, name = "total_summer_low_cub")
plot_regs(data, boots, "Deaths per 10K Summer + Max low in Month", level = 3, ylabel = "Log Mortality")
#######################
# Same as above, but use Z-score low
## Total Deaths, all months, avg low temp in county, max low temp in month
t_low <- t %>% group_by(county, fips, month, year, monthyear) %>%
summarize(maximum_low_temp_in_month = max(mean_low, na.rm = T),
avg_low_temp_in_month = mean(mean_low, na.rm = T)) %>%
group_by(fips, month) %>%
mutate(z_score_low = (maximum_low_temp_in_month - mean(maximum_low_temp_in_month)) / sd(maximum_low_temp_in_month)) %>%
ungroup
data <- left_join(m, t_low, by = c("fips", "month", "year"))
data <- data %>%
group_by(fips, measure = z_score_low, monthyear, county = county.x, income_group, population_est) %>%
summarise(deaths = sum(deaths, na.rm = T)) %>%
dplyr::filter(is.finite(measure))
data <- na.omit(data)
par(mfcol = c(3,2))
boots <- bootstrap_data(data, short=T, level=1, name = "total_low_linear")
plot_regs(data, boots, "Total Deaths + Max low in Month", level = 1)
boots <- bootstrap_data(data, short=T, level=2, name = "total_low_quad")
plot_regs(data, boots, "Total Deaths + Max low in Month", level = 2)
boots <- bootstrap_data(data, short=T, level=3, name = "total_low_cub")
plot_regs(data, boots, "Total Deaths +  Max low in Month", level = 3)
data$deaths <- log(data$deaths)
boots <- bootstrap_data(data, short=T, level=1, name = "total_low_linear")
plot_regs(data, boots, "Total Deaths + Max low in Month", level = 1, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=2, name = "total_low_quad")
plot_regs(data, boots, "Total Deaths + Max low in Month", level = 2, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=3, name = "total_low_cub")
plot_regs(data, boots, "Total Deaths +  Max low in Month", level = 3, ylabel = "Log Mortality")
## Total Deaths, summer months, avg low temp in county, max low temp in month
t_low <- t %>% group_by(county, fips, month, year, monthyear) %>%
dplyr::filter(between(month, 5, 9)) %>%
summarize(maximum_low_temp_in_month = max(mean_low, na.rm = T),
avg_low_temp_in_month = mean(mean_low, na.rm = T)) %>%
group_by(fips, month) %>%
mutate(z_score_low = (maximum_low_temp_in_month - mean(maximum_low_temp_in_month)) / sd(maximum_low_temp_in_month)) %>%
ungroup
data <- left_join(m, t_low, by = c("fips", "month", "year"))
data <- data %>%
group_by(fips, measure = z_score_low, monthyear, county = county.x, income_group, population_est) %>%
summarise(deaths = sum(deaths, na.rm = T)) %>%
dplyr::filter(is.finite(measure))
data <- na.omit(data)
par(mfcol = c(3,2))
boots <- bootstrap_data(data, short=T, level=1, name = "total_summer_low_linear")
plot_regs(data, boots, "Total Deaths Summer + Max low in Month", level = 1)
boots <- bootstrap_data(data, short=T, level=2, name = "total_summer_low_quad")
plot_regs(data, boots, "Total Deaths Summer + Max low in Month", level = 2)
boots <- bootstrap_data(data, short=T, level=3, name = "total_summer_low_cub")
plot_regs(data, boots, "Total Deaths Summer + Max low in Month", level = 3)
data$deaths <- log(data$deaths)
boots <- bootstrap_data(data, short=T, level=1, name = "total_summer_low_linear")
plot_regs(data, boots, "Total Deaths Summer + Max low in Month", level = 1, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=2, name = "total_summer_low_quad")
plot_regs(data, boots, "Total Deaths Summer + Max low in Month", level = 2, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=3, name = "total_summer_low_cub")
plot_regs(data, boots, "Total Deaths Summer + Max low in Month", level = 3, ylabel = "Log Mortality")
## PerCapita Deaths, all months, avg low temp in county, max low temp in month
t_low <- t %>% group_by(county, fips, month, year, monthyear) %>%
summarize(maximum_low_temp_in_month = max(mean_low, na.rm = T),
avg_low_temp_in_month = mean(mean_low, na.rm = T)) %>%
group_by(fips, month) %>%
mutate(z_score_low = (maximum_low_temp_in_month - mean(maximum_low_temp_in_month)) / sd(maximum_low_temp_in_month)) %>%
ungroup
data <- left_join(m, t_low, by = c("fips", "month", "year"))
data <- data %>%
group_by(fips, measure = z_score_low, monthyear, county = county.x, income_group, population_est) %>%
summarise(deaths = sum(deaths, na.rm = T)) %>%
dplyr::filter(is.finite(measure)) %>%
mutate(deaths = (deaths/as.numeric(population_est))*10000)
data <- na.omit(data)
par(mfcol = c(3,2))
boots <- bootstrap_data(data, short=T, level=1, name = "total_low_linear")
plot_regs(data, boots, "Deaths per 10K + Max low in Month", level = 1)
boots <- bootstrap_data(data, short=T, level=2, name = "total_low_quad")
plot_regs(data, boots, "Deaths per 10K + Max low in Month", level = 2)
boots <- bootstrap_data(data, short=T, level=3, name = "total_low_cub")
plot_regs(data, boots, "Deaths per 10K + Max low in Month", level = 3)
data$deaths <- log(data$deaths)
boots <- bootstrap_data(data, short=T, level=1, name = "total_low_linear")
plot_regs(data, boots, "Deaths per 10K + Max low in Month", level = 1, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=2, name = "total_low_quad")
plot_regs(data, boots, "Deaths per 10K + Max low in Month", level = 2, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=3, name = "total_low_cub")
plot_regs(data, boots, "Deaths per 10K + Max low in Month", level = 3, ylabel = "Log Mortality")
## PerCapita Deaths, summer months, avg low temp in county, max low temp in month
t_low <- t %>% group_by(county, fips, month, year, monthyear) %>%
dplyr::filter(between(month, 5, 9)) %>%
summarize(maximum_low_temp_in_month = max(mean_low, na.rm = T),
avg_low_temp_in_month = mean(mean_low, na.rm = T)) %>%
group_by(fips, month) %>%
mutate(z_score_low = (maximum_low_temp_in_month - mean(maximum_low_temp_in_month)) / sd(maximum_low_temp_in_month)) %>%
ungroup
data <- left_join(m, t_low, by = c("fips", "month", "year"))
data <- data %>%
group_by(fips, measure = z_score_low, monthyear, county = county.x, income_group, population_est) %>%
summarise(deaths = sum(deaths, na.rm = T)) %>%
dplyr::filter(is.finite(measure)) %>%
mutate(deaths = (deaths/as.numeric(population_est))*10000)
data <- na.omit(data)
par(mfcol = c(3,2))
boots <- bootstrap_data(data, short=T, level=1, name = "total_summer_low_linear")
plot_regs(data, boots, "Deaths per 10K Summer + Max low in Month", level = 1)
boots <- bootstrap_data(data, short=T, level=2, name = "total_summer_low_quad")
plot_regs(data, boots, "Deaths per 10K Summer + Max low in Month", level = 2)
boots <- bootstrap_data(data, short=T, level=3, name = "total_summer_low_cub")
plot_regs(data, boots, "Deaths per 10K Summer + Max low in Month", level = 3)
data$deaths <- log(data$deaths)
boots <- bootstrap_data(data, short=T, level=1, name = "total_summer_low_linear")
plot_regs(data, boots, "Deaths per 10K Summer + Max low in Month", level = 1, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=2, name = "total_summer_low_quad")
plot_regs(data, boots, "Deaths per 10K Summer + Max low in Month", level = 2, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=3, name = "total_summer_low_cub")
plot_regs(data, boots, "Deaths per 10K Summer + Max low in Month", level = 3, ylabel = "Log Mortality")
dev.off()
View(decomp)
head(m)
m_pops <- m %>% group_by(fips) %>% summarise(mean(population_est))
head(m_pops)
m_pops <- m %>% group_by(fips) %>% summarise(mean(as.numeric(population_est)))
head(m_pops)
m_pops <- m %>% group_by(fips) %>% summarise(mean(as.numeric(population_est))) %>% arrange()
head(m_pops)
m_pops <- m %>% group_by(fips) %>% summarise(population = mean(as.numeric(population_est))) %>% arrange()
head(m_pops)
m_pops <- m %>% group_by(fips) %>% summarise(population = mean(as.numeric(population_est))) %>% arrange(population)
head(m_pops)
?arrange
m_pops <- m %>% group_by(fips) %>% summarise(population = mean(as.numeric(population_est))) %>% arrange(desc(population))
head(m_pops)
m_pops <- mpops[1:300,]
m_pops <- m_pops[1:300,]
nrow(m_pops)
m_f <- m %>% dplyr::filter(fips %in% m_pops$fips)
View(decrease_decomp)
View(increase_npp)
head(temps)
ifelse(dir.exists("~/Box Sync/heatwave_covid"),
setwd("~/Box Sync/heatwave_covid"),
setwd("/oak/stanford/groups/omramom/group_members/aminaly/heatwave_covid"))
library(dplyr)
library(tidyverse)
library(lubridate)
library(reshape2)
temps <- read_rds("./heatwaves_manual/all_temperature_data.rds")
head(temps)
#reshape by with min and max next to each other
tm <- temps %>% dplyr::filter(measure == "tmmn")
tx <- temps %>% dplyr::filter(measure == "tmmx")
t <- left_join(tm, tx, by = c("date", "fips"))
#Add additional columns and rename for ease
t <- t %>% dplyr::select(date, county = county.x, fips,
mean_low = mean_measure.x,
mean_high = mean_measure.y) %>%
mutate(fips = as.character(fips), month = month(date), year = year(date)) %>%
dplyr::filter(is.finite(mean_low)) %>%
dplyr::filter(is.finite(mean_high))
t$monthyear <- paste0(t$month, t$year)
t_zs <- read_rds("./heatwaves_manual/all_temperature_data_clean.rds")
ifelse(dir.exists("~/Box Sync/heatwave_covid"),
setwd("~/Box Sync/heatwave_covid"),
setwd("/oak/stanford/groups/omramom/group_members/aminaly/heatwave_covid"))
ifelse(dir.exists("~/Box Sync/heatwave_covid"),
setwd("~/Box Sync/heatwave_covid"),
setwd("/oak/stanford/groups/omramom/group_members/aminaly/heatwave_covid"))
t_zs <- read_rds("./heatwaves_manual/all_temperature_data_clean.rds")
t_zs <- read_rds("./heatwaves_manual/all_temperature_data_clean.rds")
head(t_zs)
?percentile
quantile(t_zs$mean_high, .90)
head(t_zs)
?pnorm
t <- read_rds("./heatwaves_manual/all_temperature_data_clean.rds")
m <- read_rds("./calculated/all_mortality.rds")
## Recalculate z-scores for just the summer months and add in percentile value
t_zs <- t %>% group_by(fips, month) %>%
dplyr::filter(between(month, 5, 9)) %>%
mutate(z_score_high = (mean_high - mean(mean_high)) / sd(mean_high)) %>%
mutate(z_score_low = (mean_low - mean(mean_low)) / sd(mean_low)) %>%
mutate(p_high = pnorm(z_score_high)) %>%
mutate(p_low = pnorm(z_score_low)) %>%
ungroup
head(t_zs)
head(t_zs %>% dplyr::filter(fips == "31039"))
head(t_zs %>% dplyr::filter(fips == "31039"))
304-273.15
295-273.15
?count
## Per Capita Deaths, summer months, avg high temp in county, max high temp in month
t_high <- t %>% group_by(county, fips, month, year, monthyear) %>%
summarize(num_90 = length(p_high >= 0.9))
head(t_high)
## Per Capita Deaths, summer months, avg high temp in county, max high temp in month
t_high <- t_zs %>% group_by(county, fips, month, year, monthyear) %>%
summarize(num_90 = length(p_high >= 0.9))
head(t_high)
View(t_high)
## Per Capita Deaths, summer months, avg high temp in county, max high temp in month
t_high <- t_zs %>% group_by(county, fips, month, year, monthyear)
## Per Capita Deaths, summer months, avg high temp in county, max high temp in month
t_high <- t_zs %>% group_by(county, fips, month, year, monthyear) %>%
summarize(num_90 = sum(p_high >= 0.9))
## Per Capita Deaths, summer months, num days where avg high temp in county is above 90th percentile
t_low <- t_zs %>% group_by(county, fips, month, year, monthyear) %>%
summarize(num_90 = sum(p_low >= 0.9))
data <- left_join(m, t_low, by = c("fips", "month", "year"))
data <- data %>%
group_by(fips, measure = num_90, monthyear, county = county.x, income_group, population_est) %>%
summarise(deaths = sum(deaths, na.rm = T)) %>%
dplyr::filter(is.finite(measure)) %>%
mutate(deaths = (deaths/as.numeric(population_est))*100000)
data <- na.omit(data)
head(data)
unique(data$measure)
plot_title <- "Deaths per 10K + Num Days w/low above 90th Percentile"
plot_data(data, plot_title)
####################
## Quick function that takes data and plots all the variations we'd want
plot_data <- function(data, plot_title) {
par(mfcol = c(3,2))
boots <- bootstrap_data(data, short=T, level=1)
plot_regs(data, boots, plot_title, level = 1)
boots <- bootstrap_data(data, short=T, level=2)
plot_regs(data, boots, plot_title, level = 2)
boots <- bootstrap_data(data, short=T, level=3)
plot_regs(data, boots, plot_title, level = 3)
data$deaths <- log(data$deaths)
boots <- bootstrap_data(data, short=T, level=1)
plot_regs(data, boots, plot_title, level = 1, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=2)
plot_regs(data, boots, plot_title, level = 2, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=3)
plot_regs(data, boots, plot_title, level = 3, ylabel = "Log Mortality")
}
plot_data(data, plot_title)
ifelse(dir.exists("~/Box Sync/heatwave_covid"),
setwd("~/Box Sync/heatwave_covid"),
setwd("/oak/stanford/groups/omramom/group_members/aminaly/heatwave_covid"))
source("./regression_functions.R")
library(dplyr)
library(lfe)
library(ggplot2)
library(dotwhisker)
library(tidyverse)
library(lubridate)
library(reshape2)
##Read in datasets
t <- read_rds(paste0(getwd(), "/heatwaves_manual/all_temperature_data_clean.rds"))
m <- read_rds(paste0(getwd(), "/calculated/all_mortality.rds"))
#get the 300 counties with the highest populations
m_pops <- m %>% group_by(fips) %>% summarise(population = mean(as.numeric(population_est))) %>% arrange(desc(population))
m_pops <- m_pops[1:300,]
m <- m %>% dplyr::filter(fips %in% m_pops$fips)
## Recalculate z-scores for just the summer months and add in percentile value
t_zs <- t %>% group_by(fips, month) %>%
dplyr::filter(between(month, 5, 9)) %>%
mutate(z_score_high = (mean_high - mean(mean_high)) / sd(mean_high)) %>%
mutate(z_score_low = (mean_low - mean(mean_low)) / sd(mean_low)) %>%
mutate(p_high = pnorm(z_score_high)) %>%
mutate(p_low = pnorm(z_score_low)) %>%
ungroup
pdf(paste0("heatwaves_manual/visuals/regressions", Sys.Date(), ".pdf"))
##Finalize datasets for regressions & run
####################
## Quick function that takes data and plots all the variations we'd want
plot_data <- function(data, plot_title) {
print(plot_title)
par(mfcol = c(3,2))
boots <- bootstrap_data(data, short=T, level=1)
plot_regs(data, boots, plot_title, level = 1)
boots <- bootstrap_data(data, short=T, level=2)
plot_regs(data, boots, plot_title, level = 2)
boots <- bootstrap_data(data, short=T, level=3)
plot_regs(data, boots, plot_title, level = 3)
data$deaths <- log(data$deaths)
boots <- bootstrap_data(data, short=T, level=1)
plot_regs(data, boots, plot_title, level = 1, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=2)
plot_regs(data, boots, plot_title, level = 2, ylabel = "Log Mortality")
boots <- bootstrap_data(data, short=T, level=3)
plot_regs(data, boots, plot_title, level = 3, ylabel = "Log Mortality")
}
####################
##For this set of regressions, we're going to do per capita deaths, regular and log mortality,
## and only summmer months
## Per Capita Deaths, summer months, num days where avg high temp in county is above 90th percentile
t_high <- t_zs %>% group_by(county, fips, month, year, monthyear) %>%
summarize(num_90 = sum(p_high >= 0.9))
data <- left_join(m, t_high, by = c("fips", "month", "year"))
data <- data %>%
group_by(fips, measure = num_90, monthyear, county = county.x, income_group, population_est) %>%
summarise(deaths = sum(deaths, na.rm = T)) %>%
dplyr::filter(is.finite(measure)) %>%
mutate(deaths = (deaths/as.numeric(population_est))*100000)
data <- na.omit(data)
plot_title <- "Deaths per 10K + Num Days w/high above 90th Percentile"
plot_data(data, plot_title)
## Per Capita Deaths, summer months, num days where avg high temp in county is above 90th percentile
t_low <- t_zs %>% group_by(county, fips, month, year, monthyear) %>%
summarize(num_90 = sum(p_low >= 0.9))
data <- left_join(m, t_low, by = c("fips", "month", "year"))
data <- data %>%
group_by(fips, measure = num_90, monthyear, county = county.x, income_group, population_est) %>%
summarise(deaths = sum(deaths, na.rm = T)) %>%
dplyr::filter(is.finite(measure)) %>%
mutate(deaths = (deaths/as.numeric(population_est))*100000)
data <- na.omit(data)
plot_title <- "Deaths per 10K + Num Days w/low above 90th Percentile"
plot_data(data, plot_title)
## Per Capita Deaths, summer months, z score of num days where avg high temp in county is above 90th percentile
t_high <- t_zs %>% group_by(county, fips, month, year, monthyear) %>%
summarize(num_90 = sum(p_high >= 0.9)) %>%
group_by(fips, month) %>%
mutate(z_score_high = (num_90 - mean(num_90)) / sd(num_90)) %>%
ungroup
data <- left_join(m, t_high, by = c("fips", "month", "year"))
data <- data %>%
group_by(fips, measure = z_score_high, monthyear, county = county.x, income_group, population_est) %>%
summarise(deaths = sum(deaths, na.rm = T)) %>%
dplyr::filter(is.finite(measure)) %>%
mutate(deaths = (deaths/as.numeric(population_est))*100000)
data <- na.omit(data)
plot_title <- "Deaths per 10K + Zscore of Num Days w/high above 90th Percentile"
plot_data(data, plot_title)
## Per Capita Deaths, summer months, z score of num days where avg low  temp in county is above 90th percentile
t_low <- t_zs %>% group_by(county, fips, month, year, monthyear) %>%
summarize(num_90 = sum(p_low >= 0.9)) %>%
mutate(z_score_low = (num_90 - mean(num_90)) / sd(num_90)) %>%
ungroup
data <- left_join(m, t_low, by = c("fips", "month", "year"))
data <- data %>%
group_by(fips, measure = z_score_low, monthyear, county = county.x, income_group, population_est) %>%
summarise(deaths = sum(deaths, na.rm = T)) %>%
dplyr::filter(is.finite(measure)) %>%
mutate(deaths = (deaths/as.numeric(population_est))*100000)
data <- na.omit(data)
plot_title <- "Deaths per 10K + Zscore of Num days w/low above 90th Percentile"
plot_data(data, plot_title)
### Same as above, but 95th percentile
## Per Capita Deaths, summer months, num days where avg high temp in county is above 90th percentile
t_high <- t_zs %>% group_by(county, fips, month, year, monthyear) %>%
summarize(num_95 = sum(p_high >= 0.95))
data <- left_join(m, t_high, by = c("fips", "month", "year"))
data <- data %>%
group_by(fips, measure = num_95, monthyear, county = county.x, income_group, population_est) %>%
summarise(deaths = sum(deaths, na.rm = T)) %>%
dplyr::filter(is.finite(measure)) %>%
mutate(deaths = (deaths/as.numeric(population_est))*100000)
data <- na.omit(data)
plot_title <- "Deaths per 10K + Num Days w/high above 95th Percentile"
plot_data(data, plot_title)
## Per Capita Deaths, summer months, num days where avg high temp in county is above 95th percentile
t_low <- t_zs %>% group_by(county, fips, month, year, monthyear) %>%
summarize(num_95 = sum(p_low >= 0.95))
data <- left_join(m, t_low, by = c("fips", "month", "year"))
data <- data %>%
group_by(fips, measure = num_95, monthyear, county = county.x, income_group, population_est) %>%
summarise(deaths = sum(deaths, na.rm = T)) %>%
dplyr::filter(is.finite(measure)) %>%
mutate(deaths = (deaths/as.numeric(population_est))*100000)
data <- na.omit(data)
plot_title <- "Deaths per 10K + Num Days w/low above 95th Percentile"
plot_data(data, plot_title)
## Per Capita Deaths, summer months, z score of num days where avg high temp in county is above 95th percentile
t_high <- t_zs %>% group_by(county, fips, month, year, monthyear) %>%
summarize(num_95 = sum(p_high >= 0.95)) %>%
group_by(fips, month) %>%
mutate(z_score_high = (num_95 - mean(num_95)) / sd(num_95)) %>%
ungroup
data <- left_join(m, t_high, by = c("fips", "month", "year"))
data <- data %>%
group_by(fips, measure = z_score_high, monthyear, county = county.x, income_group, population_est) %>%
summarise(deaths = sum(deaths, na.rm = T)) %>%
dplyr::filter(is.finite(measure)) %>%
mutate(deaths = (deaths/as.numeric(population_est))*100000)
data <- na.omit(data)
plot_title <- "Deaths per 10K + Zscore of Num Days w/high above 95th Percentile"
plot_data(data, plot_title)
## Per Capita Deaths, summer months, z score of num days where avg high temp in county is above 95th percentile
t_low <- t_zs %>% group_by(county, fips, month, year, monthyear) %>%
summarize(num_95 = sum(p_low >= 0.9)) %>%
mutate(z_score_low  = (num_95 - mean(num_95)) / sd(num_95)) %>%
ungroup
data <- left_join(m, t_low, by = c("fips", "month", "year"))
data <- data %>%
group_by(fips, measure = z_score_low, monthyear, county = county.x, income_group, population_est) %>%
summarise(deaths = sum(deaths, na.rm = T)) %>%
dplyr::filter(is.finite(measure)) %>%
mutate(deaths = (deaths/as.numeric(population_est))*100000)
data <- na.omit(data)
plot_title <- "Deaths per 10K + Zscore of Num Days w/Low above 95th Percentile"
plot_data(data, plot_title)
## Per Capita Deaths, summer months, z score of num days where avg low  temp in county is above 90th percentile
t_low <- t_zs %>% group_by(county, fips, month, year, monthyear) %>%
summarize(num_90 = sum(p_low >= 0.9)) %>%
mutate(z_score_low = (num_90 - mean(num_90)) / sd(num_90)) %>%
ungroup
data <- left_join(m, t_low, by = c("fips", "month", "year"))
data <- data %>%
group_by(fips, measure = z_score_low, monthyear, county = county.x, income_group, population_est) %>%
summarise(deaths = sum(deaths, na.rm = T)) %>%
dplyr::filter(is.finite(measure)) %>%
mutate(deaths = (deaths/as.numeric(population_est))*100000)
head(t_low)
data <- left_join(m, t_low, by = c("fips", "month", "year"))
nrow(t_low)
mean(t_low$num_90)
sd(num_90)
sd(t_low$num_90)
head(t_high)
## Per Capita Deaths, summer months, z score of num days where avg low  temp in county is above 90th percentile
t_low <- t_zs %>% group_by(county, fips, month, year, monthyear) %>%
summarize(num_90 = sum(p_low >= 0.9)) %>%
group_by(fips, month) %>%
mutate(z_score_high = (num_90 - mean(num_90)) / sd(num_90)) %>%
ungroup
head(t_low)
unique(t_zs$year)
unique(data$year)
?stack
library(raster)
?stack
